// AIRM-IP Database Schema
// AI Risk Management Intelligence Platform
// Based on PRD v2.0 Section 7: Core Data Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION & USER MANAGEMENT
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  aiSystems       AISystem[]
  riskAssessments RiskAssessment[]
  evidence        Evidence[]
  auditLogs       AuditLog[]
  scheduledJobs   ScheduledJob[]
  invitations     Invitation[]
  apiKeys         APIKey[]
  webhooks        Webhook[]
  notifications   Notification[]

  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  passwordHash   String?
  role           UserRole @default(VIEWER)
  languagePref   String   @default("en")
  emailVerified  DateTime?
  image          String?
  isActive       Boolean  @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  ownedSystems     AISystem[]       @relation("SystemOwner")
  createdAssessments RiskAssessment[] @relation("AssessmentCreator")
  assignedTasks    Task[]           @relation("TaskAssignee")
  uploadedEvidence Evidence[]       @relation("EvidenceUploader")
  auditLogs        AuditLog[]
  createdJobs      ScheduledJob[]   @relation("JobCreator")
  savedFilters     SavedFilter[]    @relation("UserSavedFilters")
  sentInvitations  Invitation[]     @relation("InvitedByUser")
  apiKeys          APIKey[]         @relation("APIKeyCreator")
  webhooks         Webhook[]        @relation("WebhookCreator")
  notifications    Notification[]   @relation("UserNotifications")

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  @@map("users")
}

enum UserRole {
  ADMIN
  RISK_MANAGER
  ASSESSOR
  AUDITOR
  VIEWER
}

// ============================================================================
// NEXTAUTH.JS MODELS
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// AI SYSTEM INVENTORY
// ============================================================================

model AISystem {
  id                 String              @id @default(cuid())
  name               String
  description        String?             @db.Text
  systemType         AISystemType
  dataClassification DataClassification
  lifecycleStatus    LifecycleStatus     @default(DEVELOPMENT)
  riskTier           RiskTier?
  purpose            String?             @db.Text
  dataInputs         String?             @db.Text
  dataOutputs        String?             @db.Text
  thirdPartyAPIs     String[]
  baseModels         String[]
  trainingDataSources String[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Owner relation
  ownerId String
  owner   User   @relation("SystemOwner", fields: [ownerId], references: [id])

  // Relations
  riskAssessments RiskAssessment[]
  evidenceLinks   EvidenceLink[]

  @@map("ai_systems")
}

enum AISystemType {
  GENAI
  ML
  RPA
  HYBRID
  OTHER
}

enum DataClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
}

enum LifecycleStatus {
  DEVELOPMENT
  PILOT
  PRODUCTION
  DEPRECATED
  RETIRED
}

enum RiskTier {
  HIGH
  MEDIUM
  LOW
}

// ============================================================================
// COMPLIANCE FRAMEWORKS
// ============================================================================

model Framework {
  id            String    @id @default(cuid())
  name          String
  shortName     String
  version       String
  effectiveDate DateTime?
  description   String?   @db.Text
  isActive      Boolean   @default(true)
  category      FrameworkCategory
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  controls        Control[]
  sourceMappings  ControlMapping[] @relation("SourceFramework")
  targetMappings  ControlMapping[] @relation("TargetFramework")
  riskAssessments RiskAssessment[]

  @@unique([shortName, version])
  @@map("frameworks")
}

enum FrameworkCategory {
  AI_RISK
  AI_MANAGEMENT
  AI_CONTROL
  SECURITY
  COMPLIANCE
}

model Control {
  id          String   @id @default(cuid())
  code        String
  title       String
  description String?  @db.Text
  guidance    String?  @db.Text
  parentId    String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Framework relation
  frameworkId String
  framework   Framework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  // Self-relation for hierarchy
  parent   Control?  @relation("ControlHierarchy", fields: [parentId], references: [id])
  children Control[] @relation("ControlHierarchy")

  // Relations
  sourceMappings ControlMapping[] @relation("SourceControl")
  targetMappings ControlMapping[] @relation("TargetControl")
  evidenceLinks  EvidenceLink[]
  riskControls   RiskControl[]

  @@unique([frameworkId, code])
  @@map("controls")
}

model ControlMapping {
  id              String          @id @default(cuid())
  confidenceScore ConfidenceLevel
  rationale       String?         @db.Text
  mappingType     MappingType     @default(RELATED)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Source control relation
  sourceControlId String
  sourceControl   Control @relation("SourceControl", fields: [sourceControlId], references: [id], onDelete: Cascade)

  // Target control relation
  targetControlId String
  targetControl   Control @relation("TargetControl", fields: [targetControlId], references: [id], onDelete: Cascade)

  // Framework relations for easier querying
  sourceFrameworkId String
  sourceFramework   Framework @relation("SourceFramework", fields: [sourceFrameworkId], references: [id])

  targetFrameworkId String
  targetFramework   Framework @relation("TargetFramework", fields: [targetFrameworkId], references: [id])

  @@unique([sourceControlId, targetControlId])
  @@map("control_mappings")
}

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

enum MappingType {
  EQUIVALENT
  PARTIAL
  RELATED
  SUPERSET
  SUBSET
}

// ============================================================================
// RISK ASSESSMENT
// ============================================================================

model RiskAssessment {
  id               String           @id @default(cuid())
  title            String
  description      String?          @db.Text
  status           AssessmentStatus @default(DRAFT)
  assessmentDate   DateTime         @default(now())
  nextReviewDate   DateTime?
  completedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // AI System relation
  aiSystemId String
  aiSystem   AISystem @relation(fields: [aiSystemId], references: [id], onDelete: Cascade)

  // Framework relation
  frameworkId String
  framework   Framework @relation(fields: [frameworkId], references: [id])

  // Creator relation
  createdById String
  createdBy   User   @relation("AssessmentCreator", fields: [createdById], references: [id])

  // Relations
  risks         Risk[]
  evidenceLinks EvidenceLink[]

  @@map("risk_assessments")
}

enum AssessmentStatus {
  DRAFT
  IN_PROGRESS
  UNDER_REVIEW
  APPROVED
  ARCHIVED
}

model Risk {
  id                  String        @id @default(cuid())
  title               String
  description         String?       @db.Text
  category            RiskCategory
  likelihood          Int           @default(3) // 1-5 scale
  impact              Int           @default(3) // 1-5 scale
  inherentScore       Float         // likelihood × impact
  controlEffectiveness Float        @default(0) // 0-100%
  residualScore       Float         // inherentScore × (1 - controlEffectiveness)
  treatmentStatus     TreatmentStatus @default(PENDING)
  treatmentPlan       String?       @db.Text
  treatmentDueDate    DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Assessment relation
  assessmentId String
  assessment   RiskAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  // Relations
  controls      RiskControl[]
  tasks         Task[]
  evidenceLinks EvidenceLink[]

  @@map("risks")
}

enum RiskCategory {
  BIAS_FAIRNESS
  PRIVACY
  SECURITY
  RELIABILITY
  TRANSPARENCY
  ACCOUNTABILITY
  SAFETY
  OTHER
}

enum TreatmentStatus {
  PENDING
  ACCEPTED
  MITIGATING
  TRANSFERRED
  AVOIDED
  COMPLETED
}

model RiskControl {
  id            String   @id @default(cuid())
  effectiveness Float    @default(0) // 0-100%
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Risk relation
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  // Control relation
  controlId String
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([riskId, controlId])
  @@map("risk_controls")
}

// ============================================================================
// EVIDENCE MANAGEMENT
// ============================================================================

model Evidence {
  id           String         @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  fileSize     Int
  storagePath  String
  hashSha256   String
  description  String?        @db.Text
  reviewStatus EvidenceStatus @default(SUBMITTED)
  validUntil   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Uploader relation
  uploadedById String
  uploadedBy   User   @relation("EvidenceUploader", fields: [uploadedById], references: [id])

  // Relations
  links EvidenceLink[]

  @@map("evidence")
}

enum EvidenceStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

model EvidenceLink {
  id         String     @id @default(cuid())
  entityType EntityType
  createdAt  DateTime   @default(now())

  // Evidence relation
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  // Polymorphic relations (only one should be set)
  aiSystemId   String?
  aiSystem     AISystem? @relation(fields: [aiSystemId], references: [id], onDelete: Cascade)

  assessmentId String?
  assessment   RiskAssessment? @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  riskId String?
  risk   Risk?  @relation(fields: [riskId], references: [id], onDelete: Cascade)

  controlId String?
  control   Control? @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("evidence_links")
}

enum EntityType {
  AI_SYSTEM
  ASSESSMENT
  RISK
  CONTROL
}

// ============================================================================
// WORKFLOW & TASKS
// ============================================================================

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?    @db.Text
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Risk relation
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  // Assignee relation
  assigneeId String?
  assignee   User?  @relation("TaskAssignee", fields: [assigneeId], references: [id])

  @@map("tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// SCHEDULED JOBS
// ============================================================================

model ScheduledJob {
  id            String       @id @default(cuid())
  name          String
  jobType       JobType
  schedule      String       // Cron expression
  config        Json         // Report parameters
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  status        JobStatus    @default(ACTIVE)
  lastResult    Json?
  errorCount    Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById   String?
  createdBy     User?   @relation("JobCreator", fields: [createdById], references: [id])

  @@map("scheduled_jobs")
}

enum JobType {
  COMPLIANCE_REPORT
  RISK_REGISTER
  ACTIVITY_LOG
  GAP_ANALYSIS
}

enum JobStatus {
  ACTIVE
  PAUSED
  RUNNING
  FAILED
}

// ============================================================================
// SAVED FILTERS
// ============================================================================

model SavedFilter {
  id         String   @id @default(cuid())
  name       String
  entityType String   // 'ai_system', 'assessment', 'risk', 'evidence'
  filters    Json     // Filter configuration
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  userId String
  user   User   @relation("UserSavedFilters", fields: [userId], references: [id], onDelete: Cascade)

  @@map("saved_filters")
}

// ============================================================================
// INVITATION MANAGEMENT
// ============================================================================

model Invitation {
  id         String           @id @default(cuid())
  email      String
  role       UserRole         @default(VIEWER)
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invitedById String
  invitedBy   User   @relation("InvitedByUser", fields: [invitedById], references: [id])

  @@index([token])
  @@index([organizationId])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================================================
// API KEY MANAGEMENT
// ============================================================================

model APIKey {
  id          String        @id @default(cuid())
  name        String
  keyPrefix   String        // First 8 chars for identification
  keyHash     String        @unique // SHA-256 hash of full key
  permissions KeyPermission @default(READ_ONLY)
  expiresAt   DateTime?
  revokedAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("APIKeyCreator", fields: [createdById], references: [id])

  @@index([keyHash])
  @@index([organizationId])
  @@map("api_keys")
}

enum KeyPermission {
  READ_ONLY
  READ_WRITE
}

// ============================================================================
// WEBHOOK MANAGEMENT
// ============================================================================

model Webhook {
  id          String   @id @default(cuid())
  url         String
  secret      String   // HMAC signing secret
  events      String[] // Array of event type strings
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("WebhookCreator", fields: [createdById], references: [id])

  deliveries WebhookDelivery[]

  @@index([organizationId])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String         @id @default(cuid())
  eventType      String
  payload        Json
  responseStatus Int?
  responseBody   String?        @db.Text
  duration       Int?           // milliseconds
  attempt        Int            @default(1)
  status         DeliveryStatus @default(PENDING)
  nextRetryAt    DateTime?
  createdAt      DateTime       @default(now())

  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@map("webhook_deliveries")
}

enum DeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  body      String?
  link      String?          // Relative URL to navigate to
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  userId String
  user   User   @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([organizationId])
  @@map("notifications")
}

enum NotificationType {
  INVITE_ACCEPTED
  ASSESSMENT_STATUS
  RISK_CRITICAL
  WEBHOOK_FAILED
  PASSWORD_CHANGED
  ROLE_CHANGED
  SYSTEM_ALERT
}
