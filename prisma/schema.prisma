// AIRM-IP Database Schema
// AI Risk Management Intelligence Platform
// Based on PRD v2.0 Section 7: Core Data Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION & USER MANAGEMENT
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users            User[]
  aiSystems        AISystem[]
  riskAssessments  RiskAssessment[]
  evidence         Evidence[]
  auditLogs        AuditLog[]
  scheduledJobs    ScheduledJob[]
  invitations      Invitation[]
  apiKeys          APIKey[]
  webhooks         Webhook[]
  notifications    Notification[]
  vendors          Vendor[]
  changeImpacts    ChangeImpact[]
  benchmarkResults BenchmarkResult[]
  rosiCalculations ROSICalculation[]
  insights         GeneratedInsight[]
  anomalyEvents    AnomalyEvent[]
  complianceChains  ComplianceChain[]
  reportTemplates   ReportTemplate[]
  ssoConnection     SSOConnection?
  activeSessions    ActiveSession[]
  ipAllowlist       IPAllowlistEntry[]

  // Enterprise features
  brandingConfig    Json?  // { logoUrl, primaryColor, accentColor, faviconUrl, loginMessage }
  ipAllowlistEnabled Boolean @default(false)

  @@map("organizations")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?
  role          UserRole  @default(VIEWER)
  languagePref  String    @default("en")
  emailVerified DateTime?
  image         String?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // SSO fields
  ssoProvider     String?   // "saml" | null
  ssoExternalId   String?   // External user ID from IdP
  ssoManagedFields String[] // Fields managed by SCIM (cannot be edited locally)

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  ownedSystems       AISystem[]        @relation("SystemOwner")
  createdAssessments RiskAssessment[]  @relation("AssessmentCreator")
  assignedTasks      Task[]            @relation("TaskAssignee")
  uploadedEvidence   Evidence[]        @relation("EvidenceUploader")
  reviewedEvidence   Evidence[]        @relation("EvidenceReviewer")
  evidenceVersions   EvidenceVersion[] @relation("VersionUploader")
  auditLogs          AuditLog[]
  createdJobs        ScheduledJob[]    @relation("JobCreator")
  savedFilters       SavedFilter[]     @relation("UserSavedFilters")
  sentInvitations    Invitation[]      @relation("InvitedByUser")
  apiKeys            APIKey[]          @relation("APIKeyCreator")
  webhooks           Webhook[]         @relation("WebhookCreator")
  notifications      Notification[]    @relation("UserNotifications")
  dashboardLayouts   DashboardLayout[] @relation("UserDashboardLayouts")
  reportTemplates    ReportTemplate[]  @relation("ReportTemplateCreator")
  taskComments       TaskComment[]     @relation("TaskCommenter")
  activeSessions     ActiveSession[]   @relation("UserActiveSessions")

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  @@map("users")
}

enum UserRole {
  ADMIN
  RISK_MANAGER
  ASSESSOR
  AUDITOR
  VIEWER
}

// ============================================================================
// NEXTAUTH.JS MODELS
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// AI SYSTEM INVENTORY
// ============================================================================

model AISystem {
  id                  String             @id @default(cuid())
  name                String
  description         String?            @db.Text
  systemType          AISystemType
  dataClassification  DataClassification
  lifecycleStatus     LifecycleStatus    @default(DEVELOPMENT)
  riskTier            RiskTier?
  purpose             String?            @db.Text
  dataInputs          String?            @db.Text
  dataOutputs         String?            @db.Text
  thirdPartyAPIs      String[]
  baseModels          String[]
  trainingDataSources String[]
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Owner relation
  ownerId String
  owner   User   @relation("SystemOwner", fields: [ownerId], references: [id])

  // Relations
  riskAssessments RiskAssessment[]
  evidenceLinks   EvidenceLink[]

  @@map("ai_systems")
}

enum AISystemType {
  GENAI
  ML
  RPA
  HYBRID
  OTHER
}

enum DataClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
}

enum LifecycleStatus {
  DEVELOPMENT
  PILOT
  PRODUCTION
  DEPRECATED
  RETIRED
}

enum RiskTier {
  HIGH
  MEDIUM
  LOW
}

// ============================================================================
// COMPLIANCE FRAMEWORKS
// ============================================================================

model Framework {
  id            String            @id @default(cuid())
  name          String
  shortName     String
  version       String
  effectiveDate DateTime?
  description   String?           @db.Text
  isActive      Boolean           @default(true)
  category      FrameworkCategory
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Compliance scoring configuration (JSON: { compliantThreshold, partialThreshold, weights })
  scoringConfig Json?

  // Relations
  controls         Control[]
  sourceMappings   ControlMapping[]  @relation("SourceFramework")
  targetMappings   ControlMapping[]  @relation("TargetFramework")
  riskAssessments  RiskAssessment[]
  frameworkChanges FrameworkChange[]

  @@unique([shortName, version])
  @@map("frameworks")
}

enum FrameworkCategory {
  AI_RISK
  AI_MANAGEMENT
  AI_CONTROL
  SECURITY
  COMPLIANCE
}

model Control {
  id          String          @id @default(cuid())
  code        String
  title       String
  description String?         @db.Text
  guidance    String?         @db.Text
  parentId    String?
  sortOrder   Int             @default(0)
  priority    ControlPriority @default(MEDIUM)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Framework relation
  frameworkId String
  framework   Framework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  // Self-relation for hierarchy
  parent   Control?  @relation("ControlHierarchy", fields: [parentId], references: [id])
  children Control[] @relation("ControlHierarchy")

  // Relations
  sourceMappings        ControlMapping[]       @relation("SourceControl")
  targetMappings        ControlMapping[]       @relation("TargetControl")
  evidenceLinks         EvidenceLink[]
  riskControls          RiskControl[]
  mitigationInvestments MitigationInvestment[]
  complianceChains      ComplianceChain[]

  @@unique([frameworkId, code])
  @@map("controls")
}

enum ControlPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

model ControlMapping {
  id              String          @id @default(cuid())
  confidenceScore ConfidenceLevel
  rationale       String?         @db.Text
  mappingType     MappingType     @default(RELATED)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Source control relation
  sourceControlId String
  sourceControl   Control @relation("SourceControl", fields: [sourceControlId], references: [id], onDelete: Cascade)

  // Target control relation
  targetControlId String
  targetControl   Control @relation("TargetControl", fields: [targetControlId], references: [id], onDelete: Cascade)

  // Framework relations for easier querying
  sourceFrameworkId String
  sourceFramework   Framework @relation("SourceFramework", fields: [sourceFrameworkId], references: [id])

  targetFrameworkId String
  targetFramework   Framework @relation("TargetFramework", fields: [targetFrameworkId], references: [id])

  @@unique([sourceControlId, targetControlId])
  @@map("control_mappings")
}

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

enum MappingType {
  EQUIVALENT
  PARTIAL
  RELATED
  SUPERSET
  SUBSET
}

// ============================================================================
// RISK ASSESSMENT
// ============================================================================

model RiskAssessment {
  id             String           @id @default(cuid())
  title          String
  description    String?          @db.Text
  status         AssessmentStatus @default(DRAFT)
  assessmentDate DateTime         @default(now())
  nextReviewDate DateTime?
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // AI System relation
  aiSystemId String
  aiSystem   AISystem @relation(fields: [aiSystemId], references: [id], onDelete: Cascade)

  // Framework relation
  frameworkId String
  framework   Framework @relation(fields: [frameworkId], references: [id])

  // Creator relation
  createdById String
  createdBy   User   @relation("AssessmentCreator", fields: [createdById], references: [id])

  // Relations
  risks         Risk[]
  evidenceLinks EvidenceLink[]

  @@map("risk_assessments")
}

enum AssessmentStatus {
  DRAFT
  IN_PROGRESS
  UNDER_REVIEW
  APPROVED
  ARCHIVED
}

model Risk {
  id                   String          @id @default(cuid())
  title                String
  description          String?         @db.Text
  category             RiskCategory
  likelihood           Int             @default(3) // 1-5 scale
  impact               Int             @default(3) // 1-5 scale
  inherentScore        Float // likelihood × impact
  controlEffectiveness Float           @default(0) // 0-100%
  residualScore        Float // inherentScore × (1 - controlEffectiveness)
  targetScore          Float? // Target residual score after treatment
  treatmentStatus      TreatmentStatus @default(PENDING)
  treatmentPlan        String?         @db.Text
  treatmentDueDate     DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Assessment relation
  assessmentId String
  assessment   RiskAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  // Relations
  controls      RiskControl[]
  tasks         Task[]
  evidenceLinks EvidenceLink[]
  scoreHistory  RiskScoreHistory[]
  costProfile   RiskCostProfile?

  @@map("risks")
}

enum RiskCategory {
  BIAS_FAIRNESS
  PRIVACY
  SECURITY
  RELIABILITY
  TRANSPARENCY
  ACCOUNTABILITY
  SAFETY
  OTHER
}

enum TreatmentStatus {
  PENDING
  ACCEPTED
  MITIGATING
  TRANSFERRED
  AVOIDED
  COMPLETED
}

// ============================================================================
// RISK SCORE HISTORY (for trajectory visualization)
// ============================================================================

enum HistorySource {
  MANUAL // User manually updated scores
  AUTO_RECALC // System recalculated from controls
  CONTROL_CHANGE // Control effectiveness changed
  IMPORT // Imported from external source
  INITIAL // First record on risk creation
}

model RiskScoreHistory {
  id                   String        @id @default(cuid())
  inherentScore        Float
  residualScore        Float
  targetScore          Float? // Desired future state after treatment
  controlEffectiveness Float
  source               HistorySource
  notes                String?       @db.Text
  recordedAt           DateTime      @default(now())
  createdAt            DateTime      @default(now())

  // Risk relation
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  @@index([riskId, recordedAt])
  @@map("risk_score_history")
}

model RiskControl {
  id            String   @id @default(cuid())
  effectiveness Float    @default(0) // 0-100%
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Risk relation
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  // Control relation
  controlId String
  control   Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([riskId, controlId])
  @@map("risk_controls")
}

// ============================================================================
// EVIDENCE MANAGEMENT
// ============================================================================

model Evidence {
  id             String         @id @default(cuid())
  filename       String
  originalName   String
  mimeType       String
  fileSize       Int
  storagePath    String
  hashSha256     String
  description    String?        @db.Text
  reviewStatus   EvidenceStatus @default(SUBMITTED)
  currentVersion Int            @default(1)
  reviewNotes    String?        @db.Text
  validUntil     DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Uploader relation
  uploadedById String
  uploadedBy   User   @relation("EvidenceUploader", fields: [uploadedById], references: [id])

  // Reviewer relation
  reviewedById String?
  reviewedBy   User?  @relation("EvidenceReviewer", fields: [reviewedById], references: [id])

  // Relations
  links    EvidenceLink[]
  versions EvidenceVersion[]

  @@map("evidence")
}

enum EvidenceStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

model EvidenceVersion {
  id            String   @id @default(cuid())
  versionNumber Int
  filename      String
  originalName  String
  mimeType      String
  fileSize      Int
  storagePath   String
  hashSha256    String
  createdAt     DateTime @default(now())

  // Evidence parent relation
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  // Uploader relation
  uploadedById String
  uploadedBy   User   @relation("VersionUploader", fields: [uploadedById], references: [id])

  @@index([evidenceId, versionNumber])
  @@map("evidence_versions")
}

model EvidenceLink {
  id         String     @id @default(cuid())
  entityType EntityType
  createdAt  DateTime   @default(now())

  // Evidence relation
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  // Polymorphic relations (only one should be set)
  aiSystemId String?
  aiSystem   AISystem? @relation(fields: [aiSystemId], references: [id], onDelete: Cascade)

  assessmentId String?
  assessment   RiskAssessment? @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  riskId String?
  risk   Risk?   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  controlId String?
  control   Control? @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@map("evidence_links")
}

enum EntityType {
  AI_SYSTEM
  ASSESSMENT
  RISK
  CONTROL
}

// ============================================================================
// WORKFLOW & TASKS
// ============================================================================

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?    @db.Text
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Risk relation
  riskId String
  risk   Risk   @relation(fields: [riskId], references: [id], onDelete: Cascade)

  // Assignee relation
  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id])

  // Relations
  comments TaskComment[]

  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  createdAt DateTime @default(now())

  // Task relation
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Author relation
  authorId String
  author   User   @relation("TaskCommenter", fields: [authorId], references: [id])

  @@map("task_comments")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// SCHEDULED JOBS
// ============================================================================

model ScheduledJob {
  id         String    @id @default(cuid())
  name       String
  jobType    JobType
  schedule   String // Cron expression
  config     Json // Report parameters
  lastRunAt  DateTime?
  nextRunAt  DateTime?
  status     JobStatus @default(ACTIVE)
  lastResult Json?
  errorCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation("JobCreator", fields: [createdById], references: [id])

  @@map("scheduled_jobs")
}

enum JobType {
  COMPLIANCE_REPORT
  RISK_REGISTER
  ACTIVITY_LOG
  GAP_ANALYSIS
  RECURRING_ASSESSMENT
  REPORT_CLEANUP
}

enum JobStatus {
  ACTIVE
  PAUSED
  RUNNING
  FAILED
}

// ============================================================================
// REPORT TEMPLATES
// ============================================================================

model ReportTemplate {
  id         String   @id @default(cuid())
  name       String
  dataSource String // 'risks' | 'assessments' | 'compliance' | 'evidence' | 'ai-systems'
  columns    Json // Field selections
  filters    Json? // Filter criteria
  groupBy    String?
  sortBy     String?
  format     String   @default("csv") // 'csv' | 'xlsx' | 'pdf'
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("ReportTemplateCreator", fields: [createdById], references: [id])

  @@map("report_templates")
}

// ============================================================================
// SAVED FILTERS
// ============================================================================

model SavedFilter {
  id         String   @id @default(cuid())
  name       String
  entityType String // 'ai_system', 'assessment', 'risk', 'evidence'
  filters    Json // Filter configuration
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  userId String
  user   User   @relation("UserSavedFilters", fields: [userId], references: [id], onDelete: Cascade)

  @@map("saved_filters")
}

// ============================================================================
// INVITATION MANAGEMENT
// ============================================================================

model Invitation {
  id         String           @id @default(cuid())
  email      String
  role       UserRole         @default(VIEWER)
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invitedById String
  invitedBy   User   @relation("InvitedByUser", fields: [invitedById], references: [id])

  @@index([token])
  @@index([organizationId])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================================================
// API KEY MANAGEMENT
// ============================================================================

model APIKey {
  id          String        @id @default(cuid())
  name        String
  keyPrefix   String // First 8 chars for identification
  keyHash     String        @unique // SHA-256 hash of full key
  permissions KeyPermission @default(READ_ONLY)
  expiresAt   DateTime?
  revokedAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("APIKeyCreator", fields: [createdById], references: [id])

  @@index([keyHash])
  @@index([organizationId])
  @@map("api_keys")
}

enum KeyPermission {
  READ_ONLY
  READ_WRITE
}

// ============================================================================
// WEBHOOK MANAGEMENT
// ============================================================================

model Webhook {
  id          String   @id @default(cuid())
  url         String
  secret      String // HMAC signing secret
  events      String[] // Array of event type strings
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("WebhookCreator", fields: [createdById], references: [id])

  deliveries WebhookDelivery[]

  @@index([organizationId])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String         @id @default(cuid())
  eventType      String
  payload        Json
  responseStatus Int?
  responseBody   String?        @db.Text
  duration       Int? // milliseconds
  attempt        Int            @default(1)
  status         DeliveryStatus @default(PENDING)
  nextRetryAt    DateTime?
  createdAt      DateTime       @default(now())

  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@map("webhook_deliveries")
}

enum DeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  RETRYING
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  body      String?
  link      String? // Relative URL to navigate to
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  userId String
  user   User   @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([organizationId])
  @@map("notifications")
}

enum NotificationType {
  INVITE_ACCEPTED
  ASSESSMENT_STATUS
  RISK_CRITICAL
  WEBHOOK_FAILED
  PASSWORD_CHANGED
  ROLE_CHANGED
  SYSTEM_ALERT
}

// ============================================================================
// SUPPLY CHAIN MANAGEMENT
// ============================================================================

model Vendor {
  id             String           @id @default(cuid())
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  tier           Int // 1=direct, 2=sub-supplier, 3+
  riskScore      Float            @default(0)
  category       String // "ai-service", "infrastructure", "data"
  contactEmail   String?
  website        String?
  parentVendorId String?
  parentVendor   Vendor?          @relation("VendorHierarchy", fields: [parentVendorId], references: [id])
  subVendors     Vendor[]         @relation("VendorHierarchy")
  riskPaths      VendorRiskPath[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([organizationId, tier])
  @@map("vendors")
}

model VendorRiskPath {
  id             String   @id @default(cuid())
  vendorId       String
  vendor         Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  path           String[] // ordered vendor IDs from root→leaf
  aggregatedRisk Float
  createdAt      DateTime @default(now())

  @@index([vendorId])
  @@map("vendor_risk_paths")
}

// ============================================================================
// REGULATORY CHANGE MANAGEMENT
// ============================================================================

enum RegulatoryStatus {
  PROPOSED
  ENACTED
  ACTIVE
  SUPERSEDED
}

enum ImpactLevel {
  HIGH
  MEDIUM
  LOW
}

model RegulatoryChange {
  id            String           @id @default(cuid())
  source        String
  title         String
  description   String           @db.Text
  effectiveDate DateTime
  impactScore   Float
  status        RegulatoryStatus
  changeType    String

  affectedFrameworks FrameworkChange[]
  impactAssessments  ChangeImpact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, effectiveDate])
  @@map("regulatory_changes")
}

model FrameworkChange {
  id               String           @id @default(cuid())
  changeId         String
  change           RegulatoryChange @relation(fields: [changeId], references: [id], onDelete: Cascade)
  frameworkId      String
  framework        Framework        @relation(fields: [frameworkId], references: [id])
  affectedControls String[]
  remediationNotes String?          @db.Text
  createdAt        DateTime         @default(now())

  @@index([frameworkId])
  @@map("framework_changes")
}

model ChangeImpact {
  id             String           @id @default(cuid())
  changeId       String
  change         RegulatoryChange @relation(fields: [changeId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  impactLevel    ImpactLevel
  actionRequired Boolean
  dueDate        DateTime?
  assignedTo     String?
  acknowledgedAt DateTime?
  createdAt      DateTime         @default(now())

  @@index([organizationId, actionRequired])
  @@map("change_impacts")
}

// ============================================================================
// BENCHMARKING SYSTEM
// ============================================================================

model BenchmarkSnapshot {
  id               String   @id @default(cuid())
  organizationHash String
  industry         String
  orgSize          String
  metricType       String
  value            Float
  snapshotDate     DateTime @default(now())

  @@index([industry, orgSize, metricType, snapshotDate])
  @@map("benchmark_snapshots")
}

model BenchmarkResult {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metricType     String
  yourScore      Float
  industryP25    Float
  industryP50    Float
  industryP75    Float
  percentileRank Float
  sampleSize     Int
  computedAt     DateTime     @default(now())

  @@index([organizationId, metricType])
  @@map("benchmark_results")
}

// ============================================================================
// ROI CALCULATOR
// ============================================================================

model RiskCostProfile {
  id        String   @id @default(cuid())
  riskId    String   @unique
  risk      Risk     @relation(fields: [riskId], references: [id], onDelete: Cascade)
  sle       Float
  aro       Float
  ale       Float
  currency  String   @default("USD")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("risk_cost_profiles")
}

model MitigationInvestment {
  id                    String   @id @default(cuid())
  controlId             String
  control               Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)
  implementationCost    Float
  annualMaintenanceCost Float
  mitigationPercent     Float
  deploymentDate        DateTime
  currency              String   @default("USD")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([controlId])
  @@map("mitigation_investments")
}

model ROSICalculation {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  calculationDate DateTime     @default(now())
  totalALE        Float
  totalInvestment Float
  totalMitigation Float
  rosi            Float
  paybackPeriod   Float
  currency        String       @default("USD")
  createdAt       DateTime     @default(now())

  @@index([organizationId, calculationDate])
  @@map("rosi_calculations")
}

// ============================================================================
// DATA STORYTELLING
// ============================================================================

enum InsightPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AnomalySeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

model InsightTemplate {
  id        String             @id @default(cuid())
  category  String
  condition String             @db.Text
  narrative String             @db.Text
  priority  InsightPriority
  isActive  Boolean            @default(true)
  insights  GeneratedInsight[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([category, isActive])
  @@map("insight_templates")
}

model GeneratedInsight {
  id             String          @id @default(cuid())
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  templateId     String
  template       InsightTemplate @relation(fields: [templateId], references: [id])
  title          String
  narrative      String          @db.Text
  metricSnapshot Json
  detectedAt     DateTime        @default(now())
  acknowledgedAt DateTime?

  @@index([organizationId, acknowledgedAt])
  @@map("generated_insights")
}

model AnomalyEvent {
  id              String          @id @default(cuid())
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  metricType      String
  expectedValue   Float
  actualValue     Float
  deviationStdDev Float
  severity        AnomalySeverity
  detectedAt      DateTime        @default(now())
  rootCause       String?         @db.Text
  resolvedAt      DateTime?

  @@index([organizationId, severity, detectedAt])
  @@map("anomaly_events")
}

// ============================================================================
// DASHBOARD & COMPLIANCE CHAIN
// ============================================================================

enum ChainStatus {
  COMPLETE
  PARTIAL
  MISSING
}

model DashboardLayout {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation("UserDashboardLayouts", fields: [userId], references: [id], onDelete: Cascade)
  layoutName String   @default("default")
  widgets    Json
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, layoutName])
  @@map("dashboard_layouts")
}

model ComplianceChain {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requirement    String       @db.Text
  policyId       String?
  controlId      String
  control        Control      @relation(fields: [controlId], references: [id])
  evidenceIds    String[]
  chainStatus    ChainStatus
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, controlId])
  @@map("compliance_chains")
}

// ============================================================================
// SSO/SAML AUTHENTICATION
// ============================================================================

model SSOConnection {
  id             String   @id @default(cuid())
  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // SAML Configuration
  metadataUrl     String?  // IdP metadata URL (preferred)
  metadataXml     String?  @db.Text // IdP metadata XML (fallback)
  idpEntityId     String   // IdP entity ID
  idpSsoUrl       String   // IdP SSO endpoint
  idpCertificate  String   @db.Text // IdP signing certificate (PEM)

  // SP Configuration
  spEntityId      String   // SP entity ID (our app)
  acsUrl          String   // Assertion Consumer Service URL

  // Settings
  defaultRole     UserRole @default(VIEWER)
  allowedDomains  String[] // Email domains that can use this SSO
  forceSSO        Boolean  @default(false) // Disable password login for this org
  isActive        Boolean  @default(true)

  // SCIM
  scimEnabled     Boolean  @default(false)
  scimToken       String?  // Bearer token for SCIM endpoint (hashed)
  scimTokenPrefix String?  // First 8 chars for identification

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("sso_connections")
}

// ============================================================================
// ENTERPRISE SESSION MANAGEMENT
// ============================================================================

model ActiveSession {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation("UserActiveSessions", fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  sessionToken  String   @unique  // Matches JWT jti claim
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?  // Parsed from userAgent (browser, OS)
  lastActivityAt DateTime @default(now())
  expiresAt     DateTime
  isRevoked     Boolean  @default(false)
  revokedAt     DateTime?
  revokedBy     String?  // Admin who forced logout

  createdAt     DateTime @default(now())

  @@index([userId, isRevoked])
  @@index([organizationId])
  @@index([sessionToken])
  @@map("active_sessions")
}

// ============================================================================
// IP ALLOWLIST
// ============================================================================

model IPAllowlistEntry {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  cidr            String   // IP or CIDR notation (e.g., "192.168.1.0/24" or "10.0.0.1")
  description     String?  // Label for the entry (e.g., "Office VPN")
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId, isActive])
  @@map("ip_allowlist_entries")
}
